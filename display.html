<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… - Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="firebase-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        /* Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯ÙŠØ© (Ù¡ØŒ Ù¢ØŒ Ù£...) */
        .arabic-numbers {
            font-feature-settings: "liga" 0, "dlig" 0, "tnum" 1;
            font-variant-numeric: tabular-nums;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col p-2">

    <div id="notification-bar" class="fixed top-0 left-0 right-0 z-50 p-4 text-center bg-yellow-400 text-gray-900 font-bold text-3xl shadow-2xl hidden transition-all duration-300 ease-in-out">
        <span>ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… <span class="arabic-numbers">Ù¤Ù¤</span> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø© (<span id="alert-time">Ù Ù¨:Ù¤Ù¥</span> Øµ)</span>
    </div>

    <header class="flex justify-between items-center bg-gray-800 p-3 rounded-lg shadow-xl mb-2">
        <h1 id="center-name-display" class="text-3xl font-extrabold text-blue-400">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø¶Ù‰</h1>
        <div class="flex items-center space-x-6 rtl:space-x-reverse">
            <div class="text-xl font-bold arabic-numbers">
                <span id="current-time">Ù¡Ù¡:Ù¡Ù¨ Øµ</span>
                <span class="mx-2">|</span>
                <span id="current-date">Ù¢Ù© / Ù¡Ù¡ / Ù¢Ù Ù¢Ù¥</span>
            </div>
            <select id="screen-selector" class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 text-sm focus:ring-blue-500">
                <option value="1">Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 1</option>
                <option value="2">Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 2</option>
                </select>
            <button id="fullscreen-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m7-5v4m0 0h4M16 4l-5 5m5 11v-4m0 0h-4m4 4l-5-5m-7 5v-4m0 0h4m-4 4l5-5" />
                </svg>
            </button>
        </div>
    </header>

    <main class="flex flex-grow gap-2">
        <div class="w-1/4 flex flex-col space-y-2">
            <div id="clinic-cards-container" class="space-y-2 flex-grow overflow-y-hidden">
                <div class="clinic-card bg-gray-800 p-4 rounded-lg shadow-lg">
                    <p class="text-xl text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª...</p>
                </div>
            </div>

            <div class="h-48 grid grid-cols-2 gap-2">
                <div class="bg-blue-800 p-2 rounded-lg flex flex-col items-center justify-center shadow-lg">
                    <h3 class="text-lg font-bold mb-1">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                    <div id="qr-code" class="bg-white p-1 rounded">
                        
                    </div>
                    <p class="text-xs mt-1 text-blue-200">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØªØ¨Ø¹ Ø±Ù‚Ù…Ùƒ</p>
                </div>
                <div class="bg-gray-800 p-2 rounded-lg flex items-center justify-center overflow-hidden relative shadow-lg">
                    <img id="doctor-image" src="/media/doctors/default.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨" class="object-cover w-full h-full transition-opacity duration-1000">
                    <div id="doctor-name-overlay" class="absolute bottom-0 w-full bg-black bg-opacity-50 text-center text-sm p-1">
                        <span id="current-doctor-name">Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ (Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-3/4 bg-gray-800 rounded-lg shadow-2xl overflow-hidden">
            <video id="media-player" controls autoplay muted loop class="w-full h-full object-cover">
                <source src="/media/videos/awareness.mp4" type="video/mp4">
            </video>
        </div>
    </main>

    <div id="news-ticker" class="mt-2 bg-blue-600 text-white p-2 rounded-lg overflow-hidden whitespace-nowrap shadow-xl">
        <p id="ticker-content" class="text-xl font-medium inline-block animate-marquee">
            ğŸ“¢ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ­Ø±Ùƒ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠØŒ Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø²ÙŠØ§Ø±Ø© Ù…Ø±ÙŠØ­Ø© ÙˆØ³Ø±ÙŠØ¹Ø©.
        </p>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯ÙŠØ©
        function toArabicNumbers(number) {
            const arabicMap = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
            return String(number).replace(/[0-9]/g, (d) => arabicMap[d]);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ... ØªÙ‡ÙŠØ¦Ø© Firebase

            // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¯Ø§Ø¡
            window.displayCall = function(clinicName, number, time) {
                const bar = document.getElementById('notification-bar');
                const alertTime = document.getElementById('alert-time');
                const numberSpan = bar.querySelector('.arabic-numbers');
                
                numberSpan.textContent = toArabicNumbers(number);
                alertTime.textContent = time;
                bar.innerHTML = `ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… <span class="arabic-numbers">${toArabicNumbers(number)}</span> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© ${clinicName} (${time} Øµ)`;
                bar.classList.remove('hidden');

                // ØªÙ„ÙˆÙŠÙ† ÙˆÙˆÙ…ÙŠØ¶ ÙƒØ§Ø±Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
                const clinicCard = document.querySelector(`.clinic-card[data-clinic-name="${clinicName}"]`);
                if (clinicCard) {
                    clinicCard.classList.add('bg-red-500', 'animate-pulse');
                }

                // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
                setTimeout(() => {
                    bar.classList.add('hidden');
                    if (clinicCard) {
                        clinicCard.classList.remove('bg-red-500', 'animate-pulse');
                        clinicCard.classList.add('bg-gray-800'); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                    }
                }, 5000); // 5 Ø«ÙˆØ§Ù†ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§
            };

            // ... ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®ØŒ ÙˆÙ…Ù„Ø¡ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ØŒ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            // ... ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¥Ù„Ù‰ Realtime Database Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            // ... ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
            // displayCall("Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©", Ù§Ù¨, "Ù¡Ù¡:Ù£Ù ");
        });


        document.addEventListener('DOMContentLoaded', async () => {
    // ----------------------------------------------------
    // 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ø·Ù‚ (Text-to-Speech)
    // ----------------------------------------------------
    const speech = window.speechSynthesis;
    let speechRate = 1.0; // Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

    function speak(text) {
        if (!speech) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ar-EG'; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©
        utterance.rate = speechRate;
        speech.speak(utterance);
    }

    // ----------------------------------------------------
    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª)
    // ----------------------------------------------------
    const settingsDoc = await db.collection('Settings').doc('general').get();
    let settings = {};
    if (settingsDoc.exists) {
        settings = settingsDoc.data();
        document.getElementById('center-name-display').textContent = settings.centerName || 'Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ';
        document.getElementById('ticker-content').textContent = settings.newsTickerContent || 'Ù…Ø­ØªÙˆÙ‰ Ø¥Ø®Ø¨Ø§Ø±ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ';
        speechRate = settings.speechRate || 1.0;
        // Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… settings.newsTickerSpeed Ù„ØªØ¹Ø¯ÙŠÙ„ Ø³Ø±Ø¹Ø© Ø§Ù„Ù€ CSS animation
    }
    
    // ----------------------------------------------------
    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„Ø§Ø´Ø¹Ø§Ø± (ØªØ³ØªØ®Ø¯Ù… Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ù€ TTS)
    // ----------------------------------------------------

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø£Ù†Ùƒ Ø·Ù„Ø¨Øª Ù…Ù„ÙØ§Øª ØµÙˆØªÙŠØ© Ø¬Ø§Ù‡Ø²Ø© (ding.mp3, 25.mp3, clinic1.mp3)
    // ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ù…Ø«Ù„ Howler.js Ø£Ùˆ Web Audio API Ù„ØªØ´ØºÙŠÙ„ Ù…Ù„ÙØ§Øª MP3 Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„.
    
    // Ù…Ø«Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ù…Ø¬:
    function callClient(clinicName, number) {
        // 1. Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ (Ø¨Ø§ÙØªØ±Ø§Ø¶ Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API Ù„ØªØ´ØºÙŠÙ„ ding.mp3 Ùˆ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©)
        // **Ù‡Ù†Ø§ ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ding.mp3 Ø«Ù… 25.mp3 Ø«Ù… clinic1.mp3 Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„**
        
        // 2. Ø§Ù„Ù†Ø·Ù‚ (ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø£Ùˆ ØªÙƒÙ…ÙŠÙ„ÙŠØ©)
        const speechText = `Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ${number} Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© ${clinicName}`;
        speak(speechText);
        
        // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
        
        window.displayCall(clinicName, number, timeStr);
    }
    
    // ----------------------------------------------------
    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ø¨Ø± Realtime Database
    // ----------------------------------------------------
    const clinicCardsContainer = document.getElementById('clinic-cards-container');
    const screenID = 1; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ Ù‡Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 1
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©
    const clinicsToDisplay = (await fetchClinics()).filter(c => c.screenIDs.includes(screenID));

    if (clinicsToDisplay.length === 0) {
        clinicCardsContainer.innerHTML = '<p class="text-xl text-gray-400 p-4">Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµ Ø£ÙŠ Ø¹ÙŠØ§Ø¯Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©.</p>';
        return;
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ±ÙˆØª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ Realtime DB
    clinicsToDisplay.forEach(clinic => {
        const card = document.createElement('div');
        card.className = 'clinic-card bg-gray-800 p-4 rounded-lg shadow-lg transition duration-500';
        card.setAttribute('data-clinic-id', clinic.id);
        card.setAttribute('data-clinic-name', clinic.clinicName);
        
        card.innerHTML = `
            <h3 class="text-xl font-bold text-white">${clinic.clinicName}</h3>
            <p class="text-gray-400">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</p>
            <span class="current-number arabic-numbers text-7xl font-black text-green-400 block leading-none">Ù Ù </span>
            <p class="text-sm text-gray-500 mt-2">Ø¢Ø®Ø± Ù†Ø¯Ø§Ø¡: <span class="last-call-time">--</span></p>
            <p class="text-sm text-gray-500">Ø§Ù„Ø­Ø§Ù„Ø©: <span class="clinic-status font-bold ${clinic.isActive ? 'text-green-500' : 'text-red-500'}">${clinic.isActive ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØªÙˆÙ‚ÙØ©'}</span></p>
        `;
        clinicCardsContainer.appendChild(card);
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Realtime DB
        rtdb.ref('queue/' + clinic.id).on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const oldNumber = parseInt(card.querySelector('.current-number').textContent.replace(/[^0-9]/g, '')) || 0;
                const newNumber = data.currentNumber || 0;
                
                card.querySelector('.current-number').textContent = toArabicNumbers(newNumber);
                
                if (newNumber > oldNumber) {
                    callClient(clinic.clinicName, newNumber);
                }
            }
        });
        
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙÙŠ Firestore
        db.collection('Clinics').doc(clinic.id).onSnapshot(doc => {
            const isActive = doc.data().isActive;
            const statusSpan = card.querySelector('.clinic-status');
            statusSpan.textContent = isActive ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØªÙˆÙ‚ÙØ©';
            card.classList.toggle('opacity-50', !isActive); // Ù„ÙˆÙ† Ø¨Ø§Ù‡Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙ‚ÙØ©
        });
    });

    // ----------------------------------------------------
    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (Ù„ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
    // ----------------------------------------------------
    function updateDateTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
        document.getElementById('current-date').textContent = now.toLocaleDateString('ar-EG');
    }
    setInterval(updateDateTime, 1000);
    updateDateTime(); // ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ
    
    // ----------------------------------------------------
    // 6. ØªÙØ¹ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± fullscreen-btn)
    // ----------------------------------------------------
    document.getElementById('fullscreen-btn').addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    });

});
        
    </script>
</body>
</html>
