<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… - Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        /* Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯ÙŠØ© (Ù¡ØŒ Ù¢ØŒ Ù£...) */
        .arabic-numbers {
            font-feature-settings: "liga" 0, "dlig" 0, "tnum" 1;
            font-variant-numeric: tabular-nums;
        }
        /* Ø¥Ø¶Ø§ÙØ© Ù†Ù…Ø· Ù„ØªØ­Ø±ÙŠÙƒ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø± */
        @keyframes marquee {
            0%   { transform: translate(100%, 0); }
            100% { transform: translate(-100%, 0); }
        }
        .animate-marquee {
            animation: marquee 20s linear infinite; /* Ø³Ø±Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© */
        }
    </style>
    <!-- 1. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <!-- 2. Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col p-2">

    <div id="notification-bar" class="fixed top-0 left-0 right-0 z-50 p-4 text-center bg-yellow-400 text-gray-900 font-bold text-3xl shadow-2xl hidden transition-all duration-300 ease-in-out">
        <span>ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… <span class="arabic-numbers">Ù¤Ù¤</span> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø© (<span id="alert-time">Ù Ù¨:Ù¤Ù¥</span> Øµ)</span>
    </div>

    <header class="flex justify-between items-center bg-gray-800 p-3 rounded-lg shadow-xl mb-2">
        <h1 id="center-name-display" class="text-3xl font-extrabold text-blue-400">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø¶Ù‰</h1>
        <div class="flex items-center space-x-6 rtl:space-x-reverse">
            <div class="text-xl font-bold arabic-numbers">
                <span id="current-time">-- : -- Øµ</span>
                <span class="mx-2">|</span>
                <span id="current-date">-- / -- / ----</span>
            </div>
            <select id="screen-selector" class="bg-gray-700 text-white p-2 rounded-md border border-gray-600 text-sm focus:ring-blue-500">
                <option value="1">Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 1</option>
                <option value="2">Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… 2</option>
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† Firebase -->
            </select>
            <button id="fullscreen-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m7-5v4m0 0h4M16 4l-5 5m5 11v-4m0 0h-4m4 4l-5-5m-7 5v-4m0 0h4m-4 4l5-5" />
                </svg>
            </button>
        </div>
    </header>

    <main class="flex flex-grow gap-2">
        <div class="w-1/4 flex flex-col space-y-2">
            <div id="clinic-cards-container" class="space-y-2 flex-grow overflow-y-hidden">
                <div class="clinic-card bg-gray-800 p-4 rounded-lg shadow-lg">
                    <p class="text-xl text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª...</p>
                </div>
            </div>

            <div class="h-48 grid grid-cols-2 gap-2">
                <div class="bg-blue-800 p-2 rounded-lg flex flex-col items-center justify-center shadow-lg">
                    <h3 class="text-lg font-bold mb-1">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                    <div id="qr-code" class="bg-white p-1 rounded">
                        <!-- Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± QR Code -->
                        <p class="text-xs text-black">QR Code placeholder</p>
                    </div>
                    <p class="text-xs mt-1 text-blue-200">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØªØ¨Ø¹ Ø±Ù‚Ù…Ùƒ</p>
                </div>
                <div class="bg-gray-800 p-2 rounded-lg flex items-center justify-center overflow-hidden relative shadow-lg">
                    <img id="doctor-image" src="https://placehold.co/100x100/374151/f3f4f6?text=Ø·Ø¨ÙŠØ¨" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨" class="object-cover w-full h-full transition-opacity duration-1000">
                    <div id="doctor-name-overlay" class="absolute bottom-0 w-full bg-black bg-opacity-50 text-center text-sm p-1">
                        <span id="current-doctor-name">Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ (Ø·Ø¨ Ø§Ù„Ø£Ø³Ø±Ø©)</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-3/4 bg-gray-800 rounded-lg shadow-2xl overflow-hidden">
            <video id="media-player" controls autoplay muted loop class="w-full h-full object-cover">
                <source src="/media/videos/awareness.mp4" type="video/mp4">
            </video>
        </div>
    </main>

    <div id="news-ticker" class="mt-2 bg-blue-600 text-white p-2 rounded-lg overflow-hidden whitespace-nowrap shadow-xl">
        <p id="ticker-content" class="text-xl font-medium inline-block animate-marquee">
            ğŸ“¢ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø®Ø¨Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ­Ø±Ùƒ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠØŒ Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø²ÙŠØ§Ø±Ø© Ù…Ø±ÙŠØ­Ø© ÙˆØ³Ø±ÙŠØ¹Ø©.
        </p>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ (Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù€ global scope)
        window.displayCall = function(clinicName, number, time) {
            const bar = document.getElementById('notification-bar');
            const alertTime = document.getElementById('alert-time');
            const numberSpan = bar.querySelector('.arabic-numbers');
            const clinicCard = document.querySelector(`.clinic-card[data-clinic-name="${clinicName}"]`);
            const alertDuration = parseInt(document.body.getAttribute('data-alert-duration')) || 5000;

            numberSpan.textContent = toArabicNumbers(number);
            alertTime.textContent = time;
            bar.innerHTML = `ğŸ”” Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… <span class="arabic-numbers">${toArabicNumbers(number)}</span> Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© ${clinicName} (${time})`;
            bar.classList.remove('hidden');

            if (clinicCard) {
                // Ø­ÙØ¸ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ…ÙŠØ¶
                clinicCard.originalBgClass = clinicCard.classList.contains('opacity-50') ? 'opacity-50' : 'bg-gray-800';
                clinicCard.classList.add('bg-red-500', 'animate-pulse', 'shadow-red-500/50', 'ring-4', 'ring-red-500');
            }

            setTimeout(() => {
                bar.classList.add('hidden');
                if (clinicCard) {
                    clinicCard.classList.remove('bg-red-500', 'animate-pulse', 'shadow-red-500/50', 'ring-4', 'ring-red-500');
                    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
                    clinicCard.classList.add(clinicCard.originalBgClass);
                }
            }, alertDuration);
        };
        
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø·Ù‚
        const speech = window.speechSynthesis;
        let speechRate = 1.0; 
        
        function speak(text) {
            if (!speech) return;
            const utterance = new SpeechSynthesisUtterance(text);
            // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¬Ø±Ø¨Ø© Ø£ØµÙˆØ§Øª Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ù„Ù‡Ø¬Ø§Øª Ù„ØªØ¬Ø¯ Ø§Ù„Ø£ÙØ¶Ù„
            utterance.lang = 'ar-SA'; 
            utterance.rate = speechRate;
            speech.speak(utterance);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø¯Ø§Ø¡ (ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ ÙˆØ§Ù„Ø§Ø´Ø¹Ø§Ø±)
        function callClient(clinicName, number) {
            // 1. Ø§Ù„Ù†Ø·Ù‚
            const speechText = `Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ${number} Ø§Ù„ØªÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø¹ÙŠØ§Ø¯Ø© ${clinicName}`;
            speak(speechText);
            
            // 2. Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨ØµØ±ÙŠ
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
            
            window.displayCall(clinicName, number, timeStr);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            
            // ----------------------------------------------------
            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
            // ----------------------------------------------------
            function updateDateTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
                document.getElementById('current-date').textContent = now.toLocaleDateString('ar-EG');
            }
            setInterval(updateDateTime, 1000);
            updateDateTime(); 

            // ----------------------------------------------------
            // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª)
            // ----------------------------------------------------
            const settingsDoc = await db.collection('Settings').doc('general').get();
            let settings = {};
            if (settingsDoc.exists) {
                settings = settingsDoc.data();
                document.getElementById('center-name-display').textContent = settings.centerName || 'Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ';
                document.getElementById('ticker-content').textContent = settings.newsTickerContent || 'Ù…Ø­ØªÙˆÙ‰ Ø¥Ø®Ø¨Ø§Ø±ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ';
                speechRate = settings.speechRate || 1.0;
                document.body.setAttribute('data-alert-duration', (settings.alertDuration || 7) * 1000);
                
                // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø±Ø¹Ø© Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
                const tickerElement = document.getElementById('ticker-content');
                const speed = (settings.newsTickerSpeed || 5) * 4; // ØªØ­ÙˆÙŠÙ„ 1-10 Ø¥Ù„Ù‰ Ø«ÙˆØ§Ù†ÙŠ (40s Ø¨Ø·ÙŠØ¡ØŒ 4s Ø³Ø±ÙŠØ¹)
                tickerElement.style.animationDuration = `${45 - (settings.newsTickerSpeed * 4)}s`;
            }
            
            // ----------------------------------------------------
            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ø¨Ø± Realtime Database (Ù‚Ù„Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©)
            // ----------------------------------------------------
            const clinicCardsContainer = document.getElementById('clinic-cards-container');
            const screenSelector = document.getElementById('screen-selector');
            
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø© Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯Ø©
            let screenID = parseInt(screenSelector.value) || 1; 
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©
            const allClinics = await fetchClinics();
            const clinicsToDisplay = allClinics.filter(c => c.screenIDs && c.screenIDs.includes(screenID));

            if (clinicsToDisplay.length === 0) {
                clinicCardsContainer.innerHTML = '<p class="text-xl text-gray-400 p-4">Ù„Ù… ÙŠØªÙ… ØªØ®ØµÙŠØµ Ø£ÙŠ Ø¹ÙŠØ§Ø¯Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©). Ø§Ø®ØªØ± Ø´Ø§Ø´Ø© Ø£Ø®Ø±Ù‰.</p>';
                // ÙŠØ¬Ø¨ Ù‡Ù†Ø§ Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† Firestore
                const screensSnapshot = await db.collection('Screens').get();
                screensSnapshot.forEach(doc => {
                    if (doc.id !== screenID.toString()) {
                         const option = document.createElement('option');
                         option.value = doc.data().screenID;
                         option.textContent = `Ø§Ù„Ø´Ø§Ø´Ø© Ø±Ù‚Ù… ${doc.data().screenID}`;
                         screenSelector.appendChild(option);
                    }
                });
                return;
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"
            clinicCardsContainer.innerHTML = ''; 

            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ±ÙˆØª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ù€ Realtime DB Ùˆ Firestore
            clinicsToDisplay.forEach(clinic => {
                const card = document.createElement('div');
                card.className = 'clinic-card bg-gray-800 p-4 rounded-lg shadow-lg transition duration-500';
                card.setAttribute('data-clinic-id', clinic.id);
                card.setAttribute('data-clinic-name', clinic.clinicName);
                
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-white">${clinic.clinicName}</h3>
                    <p class="text-gray-400">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</p>
                    <span class="current-number arabic-numbers text-7xl font-black text-green-400 block leading-none">Ù Ù </span>
                    <p class="text-sm text-gray-500 mt-2">Ø¢Ø®Ø± Ù†Ø¯Ø§Ø¡: <span class="last-call-time">--</span></p>
                    <p class="text-sm text-gray-500">Ø§Ù„Ø­Ø§Ù„Ø©: <span class="clinic-status font-bold ${clinic.isActive ? 'text-green-500' : 'text-red-500'}">${clinic.isActive ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØªÙˆÙ‚ÙØ©'}</span></p>
                `;
                clinicCardsContainer.appendChild(card);
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Realtime DB
                rtdb.ref('queue/' + clinic.id).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const currentNumberElement = card.querySelector('.current-number');
                        const lastCallTimeElement = card.querySelector('.last-call-time');
                        
                        const oldNumber = parseInt(currentNumberElement.textContent.replace(/[^0-9]/g, '')) || 0;
                        const newNumber = data.currentNumber || 0;
                        
                        currentNumberElement.textContent = toArabicNumbers(newNumber);
                        
                        if (data.lastCallTime) {
                            const callTime = new Date(data.lastCallTime).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true });
                            lastCallTimeElement.textContent = callTime;
                        }
                        
                        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø§Ù„ØµÙˆØªÙŠ Ø¹Ù†Ø¯ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…
                        if (newNumber > oldNumber) {
                            callClient(clinic.clinicName, newNumber);
                        }
                    } else {
                        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù‚Ø¯Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                        rtdb.ref('queue/' + clinic.id).set({ currentNumber: 0, lastCallTime: new Date().toISOString() });
                    }
                }, error => {
                    console.error("Realtime DB Listener Error for clinic", clinic.clinicName, error);
                });
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙÙŠ Firestore
                db.collection('Clinics').doc(clinic.id).onSnapshot(doc => {
                    if (doc.exists) {
                        const isActive = doc.data().isActive;
                        const statusSpan = card.querySelector('.clinic-status');
                        statusSpan.textContent = isActive ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØªÙˆÙ‚ÙØ©';
                        statusSpan.classList.toggle('text-green-500', isActive);
                        statusSpan.classList.toggle('text-red-500', !isActive);
                        card.classList.toggle('opacity-50', !isActive); // Ù„ÙˆÙ† Ø¨Ø§Ù‡Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙ‚ÙØ©
                    }
                }, error => {
                    console.error("Firestore Listener Error for clinic", clinic.clinicName, error);
                });
            });

            // ----------------------------------------------------
            // 4. ØªÙØ¹ÙŠÙ„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
            // ----------------------------------------------------
            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

        });
        
    </script>
</body>
</html>
