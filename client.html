<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø·Ø¨Ø§Ø¹Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .arabic-numbers { font-feature-settings: "liga" 0, "dlig" 0, "tnum" 1; font-variant-numeric: tabular-nums; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body {
                background: none;
                margin: 0;
                padding: 0;
            }
            #print-controls {
                display: none;
            }
            .ticket-grid {
                page-break-after: always; /* Ù„Ø¨Ø¯Ø¡ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© */
            }
            /* ØªØ­Ø¯ÙŠØ¯ Ø­Ø¬Ù… Ø§Ù„ØªØ°ÙƒØ±Ø©: 5 Ø³Ù… ÙÙŠ 5 Ø³Ù… Ø¹Ù„Ù‰ ØµÙØ­Ø© A4 */
            .ticket-item {
                width: 5cm;
                height: 5cm;
                border: 1px solid #000; /* Ø­Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ù‚Øµ */
                padding: 5px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
                float: right; /* Ù„Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø± */
            }
        }
    </style>
    <!-- 1. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- 2. Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">

    <div id="print-controls" class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <h1 class="text-3xl font-bold text-yellow-700 mb-4 border-b pb-2">ğŸ–¨ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø·Ø¨Ø§Ø¹Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ø·Ø§Ø¨ÙˆØ±</h1>
        
        <div class="grid grid-cols-4 gap-4 items-end">
            <select id="clinic-select-print" class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</option>
                </select>
            <input type="number" id="start-number" placeholder="Ù…Ù† Ø±Ù‚Ù…" class="p-3 border border-gray-300 rounded-lg arabic-numbers">
            <input type="number" id="end-number" placeholder="Ø¥Ù„Ù‰ Ø±Ù‚Ù…" class="p-3 border border-gray-300 rounded-lg arabic-numbers">
            <button id="generate-tickets-btn" class="bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700 transition">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ°Ø§ÙƒØ±</button>
        </div>
    </div>

    <div id="tickets-output" class="max-w-4xl mx-auto bg-white p-4 hidden">
        <div id="ticket-grid" class="flex flex-wrap items-start justify-start gap-0.5">
            </div>
    </div>
    
    <script>
        
        document.addEventListener('DOMContentLoaded', async () => {
            // **Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ØªÙ‡ÙŠØ¦Ø© Firebase**
            initFirebase(); 

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ù„Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const allClinics = await fetchClinics();
            populateClinicSelect('clinic-select-print', allClinics);
            
            document.getElementById('generate-tickets-btn').addEventListener('click', async () => {
                const startNum = parseInt(document.getElementById('start-number').value);
                const endNum = parseInt(document.getElementById('end-number').value);
                const clinicNameElement = document.querySelector('#clinic-select-print option:checked');
                const clinicName = clinicNameElement ? clinicNameElement.textContent : 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©';

                if (isNaN(startNum) || isNaN(endNum) || startNum > endNum || !clinicNameElement || !clinicNameElement.value) {
                    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø·Ø§Ù‚ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©.");
                    return;
                }

                // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ² Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                let centerName = "Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ø¨ÙŠ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"; 
                try {
                    const settingsDoc = await db.collection('Settings').doc('general').get();
                    if (settingsDoc.exists) {
                        centerName = settingsDoc.data().centerName || centerName;
                    }
                } catch (e) {
                    console.error("Could not fetch center name:", e);
                }

                const outputContainer = document.getElementById('ticket-grid');
                outputContainer.innerHTML = '';
                document.getElementById('tickets-output').classList.remove('hidden');

                const currentDate = new Date().toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                
                // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ°Ø§ÙƒØ±
                for (let i = startNum; i <= endNum; i++) {
                    const ticketHtml = `
                        <div class="ticket-item text-gray-900">
                            <p class="text-xs font-medium text-gray-700">${centerName}</p>
                            <div class="text-center my-1">
                                <p class="text-xl font-bold">${clinicName}</p>
                                <p class="text-xs">Ø§Ù„Ø±Ù‚Ù…:</p>
                                <span class="arabic-numbers text-6xl font-black text-red-700 leading-none">${toArabicNumbers(i)}</span>
                            </div>
                            <div class="text-xs w-full border-t pt-1">
                                <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${toArabicNumbers(currentDate)}</p>
                                <p>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: <span class="arabic-numbers">Ù Ù </span> Ø¯Ù‚ÙŠÙ‚Ø©</p>
                            </div>
                        </div>
                    `;
                    outputContainer.innerHTML += ticketHtml;
                }

                // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                setTimeout(() => window.print(), 100);
            });
        });
    </script>
</body>
</html>
