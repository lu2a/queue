<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
        .arabic-numbers { font-feature-settings: "liga" 0, "dlig" 0, "tnum" 1; font-variant-numeric: tabular-nums; }
        .control-btn { transition: background-color 0.2s, transform 0.1s; }
        .control-btn:active { transform: scale(0.98); }
    </style>
    <!-- 1. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- 2. Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

    <div id="login-form" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl text-center">
        <h2 class="text-3xl font-bold text-indigo-700 mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ­ÙƒÙ…</h2>
        <div class="space-y-4">
            <select id="clinic-selector" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª...</option>
                </select>
            <input type="password" id="clinic-password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="control-panel" class="w-full max-w-4xl bg-white p-8 rounded-xl shadow-2xl hidden">
        
        <header class="flex justify-between items-center mb-6 pb-4 border-b">
            <h1 id="clinic-title" class="text-3xl font-extrabold text-indigo-700">Ø¹ÙŠØ§Ø¯Ø© --</h1>
            <div class="text-center">
                <p class="text-gray-500 text-lg">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</p>
                <span id="current-number-display" class="arabic-numbers text-6xl font-black text-red-600 leading-none">Ù Ù </span>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <button id="next-client-btn" class="control-btn bg-green-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-green-700">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
            <button id="repeat-call-btn" class="control-btn bg-yellow-500 text-white py-4 rounded-xl text-xl font-bold hover:bg-yellow-600">ØªÙƒØ±Ø§Ø± Ø§Ù„Ù†Ø¯Ø§Ø¡ ğŸ”Š</button>
            <button id="stop-clinic-btn" class="control-btn bg-red-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-red-700">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ğŸ›‘</button>
            <button id="reset-clinic-btn" class="control-btn bg-gray-600 text-white py-4 rounded-xl text-xl font-bold hover:bg-gray-700">ØªØµÙÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ğŸ”„</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-6">
            
            <div class="p-3 bg-indigo-50 rounded-lg">
                <p class="text-indigo-700 font-semibold mb-2">Ù†Ø¯Ø§Ø¡ Ù…Ø®ØµØµ</p>
                <div class="flex space-x-2 rtl:space-x-reverse">
                    <button id="prev-client-btn" class="control-btn bg-purple-500 text-white py-2 px-3 rounded-md text-sm hover:bg-purple-600">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ â¬…ï¸</button>
                    <input type="number" id="specific-number-input" placeholder="Ø±Ù‚Ù… Ø¹Ù…ÙŠÙ„" class="w-1/3 p-2 border rounded-md text-sm arabic-numbers">
                    <button id="call-specific-btn" class="control-btn bg-indigo-500 text-white py-2 px-3 rounded-md text-sm hover:bg-indigo-600">Ù†Ø¯Ø§Ø¡</button>
                </div>
            </div>

            <div class="p-3 bg-red-50 rounded-lg">
                <p class="text-red-700 font-semibold mb-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</p>
                <div class="flex space-x-2 rtl:space-x-reverse">
                    <button id="emergency-call-btn" class="control-btn w-1/2 bg-red-600 text-white py-2 rounded-md text-sm hover:bg-red-700">ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦ ğŸš¨</button>
                    <select id="transfer-clinic-select" class="w-1/2 p-2 border rounded-md text-sm">
                        <option value="">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰...</option>
                        </select>
                </div>
            </div>
            
            <div class="p-3 bg-teal-50 rounded-lg">
                <p class="text-teal-700 font-semibold mb-2">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</p>
                <div class="flex space-x-2 rtl:space-x-reverse">
                    <button id="alert-doctor-btn" class="control-btn w-1/2 bg-teal-600 text-white py-2 rounded-md text-sm hover:bg-teal-700">ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠØ¨ ğŸ§‘â€âš•ï¸</button>
                    <button id="alert-client-online-btn" class="control-btn w-1/2 bg-yellow-600 text-white py-2 rounded-md text-sm hover:bg-yellow-700">ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù…ÙŠÙ„ (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†) ğŸ“±</button>
                </div>
            </div>
        </div>

        <button id="logout-btn" class="mt-8 bg-gray-400 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-500 transition float-left">Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // **Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ØªÙ‡ÙŠØ¦Ø© Firebase**
            initFirebase(); 
            
            // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„
            const allClinics = await fetchClinics();
            populateClinicSelect('clinic-selector', allClinics);
            populateClinicSelect('transfer-clinic-select', allClinics); 

            let currentClinicId = null;

            // ----------------------------------------------------
            // 2. ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙÙŠ Firestore)
            // ----------------------------------------------------
            document.getElementById('login-btn').addEventListener('click', async () => {
                const clinicId = document.getElementById('clinic-selector').value;
                const password = document.getElementById('clinic-password').value;

                if (!clinicId || !password) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.');
                    return;
                }

                try {
                    // db Ù‡Ùˆ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù†
                    const clinicDoc = await db.collection('Clinics').doc(clinicId).get();

                    if (clinicDoc.exists && clinicDoc.data().controlPassword === password) {
                        currentClinicId = clinicId;
                        document.getElementById('login-form').classList.add('hidden');
                        document.getElementById('control-panel').classList.remove('hidden');

                        const clinicName = clinicDoc.data().clinicName;
                        document.getElementById('clinic-title').textContent = `Ø¹ÙŠØ§Ø¯Ø© ${clinicName}`;
                        
                        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        // rtdb Ù‡Ùˆ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù†
                        rtdb.ref('queue/' + currentClinicId).on('value', (snapshot) => {
                            const data = snapshot.val();
                            const currentNumber = data ? data.currentNumber : 0;
                            document.getElementById('current-number-display').textContent = toArabicNumbers(currentNumber);
                        }, error => {
                            console.error("Control Panel RTDB Error:", error);
                        });
                        
                    } else {
                        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.');
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.');
                }
            });

            // ----------------------------------------------------
            // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ (ØªØ­Ø¯ÙŠØ« Realtime DB)
            // ----------------------------------------------------
            document.getElementById('next-client-btn').addEventListener('click', async () => {
                if (!currentClinicId) return;

                const currentNumberSpan = document.getElementById('current-number-display');
                const currentNumber = parseInt(currentNumberSpan.textContent.replace(/[^0-9]/g, '')) || 0;
                const nextNumber = currentNumber + 1;

                try {
                    // rtdb Ù‡Ùˆ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù†
                    await rtdb.ref('queue/' + currentClinicId).update({
                        currentNumber: nextNumber,
                        lastCallTime: new Date().toISOString()
                    });
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ù‚ Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                } catch (error) {
                    console.error("Error moving to next client:", error);
                    alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ø¨ÙˆØ±. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©.');
                }
            });

            // ----------------------------------------------------
            // 4. ÙˆØ¸ÙŠÙØ© Ø¥ÙŠÙ‚Ø§Ù/Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (ØªØ­Ø¯ÙŠØ« Firestore)
            // ----------------------------------------------------
            document.getElementById('stop-clinic-btn').addEventListener('click', async () => {
                if (!currentClinicId) return;
                const btn = document.getElementById('stop-clinic-btn');
                const isActive = btn.textContent.includes('Ø¥ÙŠÙ‚Ø§Ù');

                try {
                    // db Ù‡Ùˆ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù†
                    await db.collection('Clinics').doc(currentClinicId).update({
                        isActive: !isActive
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø±
                    if (isActive) {
                        btn.textContent = 'Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ğŸŸ¢';
                        btn.classList.replace('bg-red-600', 'bg-green-600');
                    } else {
                        btn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ğŸ›‘';
                        btn.classList.replace('bg-green-600', 'bg-red-600');
                    }
                    alert(`ØªÙ… ${isActive ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'Ø§Ø³ØªØ¦Ù†Ø§Ù'} Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.`);
                } catch (error) {
                    console.error("Error toggling clinic status:", error);
                    alert('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©.');
                }
            });

            // 5. ÙˆØ¸ÙŠÙØ© ØªØµÙÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
            document.getElementById('reset-clinic-btn').addEventListener('click', async () => {
                if (!currentClinicId) return;
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©ØŸ')) return;

                try {
                    // rtdb Ù‡Ùˆ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ø§Ù„Ø¢Ù†
                    await rtdb.ref('queue/' + currentClinicId).update({
                        currentNumber: 0,
                        lastCallTime: new Date().toISOString()
                    });
                    alert('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©.');
                } catch (error) {
                    console.error("Error resetting clinic:", error);
                }
            });
            
            // 6. ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„
            document.getElementById('transfer-clinic-select').addEventListener('change', async function() {
                if (!currentClinicId || !this.value) return;
                const transferToId = this.value;

                const currentNumberSpan = document.getElementById('current-number-display');
                const currentNumber = parseInt(currentNumberSpan.textContent.replace(/[^0-9]/g, '')) || 0;

                if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… ${toArabicNumbers(currentNumber)} Ø¥Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ`)) {
                    this.value = ''; 
                    return;
                }

                try {
                    // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø©
                    await rtdb.ref('queue/' + transferToId).update({
                        currentNumber: currentNumber,
                        lastCallTime: new Date().toISOString()
                    });
                    alert('ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø¹ÙŠØ§Ø¯ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©.');
                    this.value = ''; 
                } catch (error) {
                    console.error("Error transferring client:", error);
                }
            });

            // 7. Ø§Ù„Ø®Ø±ÙˆØ¬
            document.getElementById('logout-btn').addEventListener('click', () => {
                currentClinicId = null;
                document.getElementById('control-panel').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });

        });
    </script>
</body>
</html>
