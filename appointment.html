<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-purple-50 min-h-screen p-8">
    <div class="max-w-xl mx-auto bg-white p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl font-bold text-purple-700 mb-6 border-b pb-4">ğŸ“… Ø·Ù„Ø¨ Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</h1>

        <form id="appointment-form" class="space-y-6">
            
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="app-client-name" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ *" class="p-3 border rounded-lg">
                <input type="text" id="app-national-id" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ" class="p-3 border rounded-lg">
                <input type="tel" id="app-phone" required placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† *" class="p-3 border rounded-lg">
            </div>

            <select id="app-clinic-select" required class="w-full p-3 border rounded-lg focus:ring-purple-500 focus:border-purple-500">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© *</option>
                </select>
            
            <div class="grid grid-cols-2 gap-4">
                <label class="block">
                    <span class="text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ *</span>
                    <input type="date" id="app-date" required class="w-full p-3 border rounded-lg mt-1">
                </label>
                <label class="block">
                    <span class="text-gray-700">Ø§Ù„ØªÙˆÙ‚ÙŠØª (Ø§Ù„Ø´ÙŠÙØª) *</span>
                    <select id="app-shift" required class="w-full p-3 border rounded-lg mt-1 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠÙØª</option>
                        <option value="morning">ØµØ¨Ø§Ø­ÙŠ (Ù Ù¨:Ù Ù  Øµ - Ù¡Ù¤:Ù Ù  Ù…)</option>
                        <option value="evening">Ù…Ø³Ø§Ø¦ÙŠ (Ù¡Ù¤:Ù Ù  Ù… - Ù¢Ù :Ù Ù  Ù…)</option>
                    </select>
                </label>
            </div>
            
            <textarea id="app-reason" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ø§Ø®ØªØµØ§Ø±" rows="3" class="w-full p-3 border rounded-lg"></textarea>
            
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 transition">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø²</button>
            <p id="appointment-limit-msg" class="text-sm text-center text-red-500 hidden">Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠÙØª Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„.</p>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... ØªÙ‡ÙŠØ¦Ø© Firebase
            
            document.getElementById('appointment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const appointmentData = {
                    clientName: document.getElementById('app-client-name').value,
                    clinicId: document.getElementById('app-clinic-select').value,
                    date: document.getElementById('app-date').value,
                    shift: document.getElementById('app-shift').value,
                    status: 'pending', // Ø­Ø§Ù„Ø© Ø£ÙˆÙ„ÙŠØ©
                    timestamp: new Date().toISOString()
                    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                };

                // **Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª (ÙŠØªØ·Ù„Ø¨ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ù† Firestore)**
                // const clinicMax = 50; // ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ù‡Ø°Ø§ Ù…Ù† Clinics Collection
                // const currentAppointmentsCount = 45; // ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ù‡Ø°Ø§ Ù…Ù† Appointments Collection Ø¨ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø´ÙŠÙØª
                
                // if (currentAppointmentsCount >= clinicMax) {
                //     document.getElementById('appointment-limit-msg').classList.remove('hidden');
                //     alert('Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠÙØª Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„.');
                //     return;
                // }

                // **Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Firestore (Appointments Collection)**
                // db.collection('Appointments').add(appointmentData)
                //     .then(() => {
                //         alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„Ù„ØªØ£ÙƒÙŠØ¯.');
                //         document.getElementById('appointment-form').reset();
                //     })
                //     .catch(error => console.error("Error submitting appointment: ", error));
            });
        });

        document.addEventListener('DOMContentLoaded', async () => {
    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª
    const allClinics = await fetchClinics();
    populateClinicSelect('app-clinic-select', allClinics);
    
    // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬Ø² (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„)
    document.getElementById('appointment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const clinicId = document.getElementById('app-clinic-select').value;
        const date = document.getElementById('app-date').value;
        const shift = document.getElementById('app-shift').value;
        const clientName = document.getElementById('app-client-name').value;
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª
        const clinicDoc = await db.collection('Clinics').doc(clinicId).get();
        if (!clinicDoc.exists) return alert('Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.');
        const maxAppointments = clinicDoc.data().maxAppointments || 50;
        
        // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø´ÙŠÙØª
        const appointmentsSnapshot = await db.collection('Appointments')
            .where('clinicId', '==', clinicId)
            .where('date', '==', date)
            .where('shift', '==', shift)
            .get();

        const currentAppointmentsCount = appointmentsSnapshot.size;
        
        if (currentAppointmentsCount >= maxAppointments) {
            document.getElementById('appointment-limit-msg').classList.remove('hidden');
            alert('Ø¹ÙÙˆØ§Ù‹ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠÙØª Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„.');
            return;
        }

        const appointmentData = {
            clientName: clientName,
            nationalID: document.getElementById('app-national-id').value,
            phone: document.getElementById('app-phone').value,
            clinicId: clinicId,
            date: date,
            shift: shift,
            reason: document.getElementById('app-reason').value,
            status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('Appointments').add(appointmentData);
            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„Ù„ØªØ£ÙƒÙŠØ¯.');
            document.getElementById('appointment-form').reset();
        } catch (error) {
            console.error("Error submitting appointment:", error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø².');
        }
    });
});
    </script>
</body>
</html>
